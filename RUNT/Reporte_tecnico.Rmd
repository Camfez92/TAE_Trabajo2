---
title: "NUMERO DE VEHICULOS REGISTRADOS EN EL SISTEMA DE TRANSITO NACIONAL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



```{r, echo=FALSE}
##Carga de librerias
library("readxl")
library("DT")
library("tidyverse")
library("lubridate")
library("plotly")
library("summarytools")
library("zoo")
library("forcats")
```


```{r, echo=FALSE}
#Carga de datos
#La carga de los datos es mejor realizarla con la librería read_excel, si lo hacemos como lo hicimos en el trabajo pasado, genera errores o se cargan los datos mal (traté con varios encoding y todos generaban errores).

db=read_excel("autos.xlsx")
```

```{r}
save(db, file = "Autos.RData")
```


# Análisis descriptivo

La base de datos que se va a emplear para proyectar el número de vehículos a registrar en el **Registro Único Nacional de Tránsito**, ***RUNT*** contiene un registro del número de vehículos que han sido registrados diariamente entre el primero de enero de 2012 (2012-01-01) y el 31 de diciembre de 2017 (2017-12-31), lo que implica que parte con solo dos variables: la fecha y el número de vehículos registrados en el RUNT en cada fecha, con 2,192 observaciones que abarcan la totalidad de días que transcurrieron entre las dos fechas límite. Con esto claro, se desarrolla la siguiente serie de tiempo que ilustra el número de vehículos registrados por día.

```{r}
glimpse(db)
```
```{r, echo = FALSE, warning = FALSE, message = FALSE}
g1 <- ggplot(db, aes(x = as.Date(Fecha), y = Unidades)) +
      geom_line(size = 0.1, color = "#4d85ea") +
      ggtitle("Número de vehículos registrados en el RUNT¹ por día",
              subtitle = "¹ Registro Único Nacional de Tránsito") +
      xlab("Fecha [AAAA-MM-DD]") +
      ylab("Vehículos registrados") +
      scale_x_date(date_labels = "%b'%y",
                   date_minor_breaks = "3 month") +
      theme_light()
ggplotly(g1)
```
De este gráfico se pueden destacar varias cosas. La primera de ellas es que la venta de vehículos presenta con bastante frecuencias días con cero registros nuevos, aspecto que se indagará más adelante. Asimismo, parece que las ventas medias se preservan en la mayor parte del año, con un pequeño pico al finalizar el primer trimestre y otro más destacado finalizando el año. Asimismo, se puede ver que el número de vehículos registrados en el RUNT parece tener un decenso a partir del año 2016, pues antes de este año es frecuente que se superasen los mil carros registrados por día, toda vez que a partir de este año esto pasa a ser menos frecuente. Así, considerando estos datos, se obtienen los siguientes resúmenes numéricos para el número de vehículos registrado por día:

```{r, include = FALSE}
descr(db)
```

| Parámetro                | Valor  |
|--------------------------|--------|
| Media                    | 782.17 |
| Desviación estándar      | 551.16 |
| Mínimo                   | 0      |
| Primer cuantil (Q1)      | 293    |
| Mediana (Q2)             | 865.5  |
| Tercer cuantil (Q3)      | 1,173  |
| Máximo (Q4)              | 3,603  |
| Rango intercuartídico    | 880    |
| Coeficiente de variación | 0.7    |
| Coeficiente de asimetría | 0.05   |
| Curtosis                 | 0.35   |

Como se observa, cada día entre los años 2012 y 2017 (inclusive) se registraron 782.17 vehículos en el RUNT en promedio, con una desviación estándar de 551.16 vehículos por día, y presentando un mínimo en cero vehículos por día (lo cual sucede durante varios días como se podrá verificar más adelante), y un máximo de 3,603 vehículos, lo cual ocurrió el 29 de diciembre del 2016. Además, se tiene que la mediana se da en 865.5 vehículos, lo que quiere decir que en al menos la mitad de los días del periodo mencionado se registraron 366 vehículos o más, y en el resto de días 365 vehículos o menos. Por último, se debe destacar que el coeficiente de variación es de 0.7 (70%), lo que muestra que el promedio no es representativo del conjunto de datos; asimismo, el coeficiente de asimetría es de 0.05, lo cual muestra que los datos están concentrados hacia el promedio de 782.17 vehículos registrados por día en el RUNT, pero con una ligera tendencia hacia un menor número de registros diarios, toda vez que la curtosis de 0.35, lo que implica que la distribución presenta una menor cantidad de datos atípicos comparado con una distribución normal y una mayor concentración alrededor de su media. Esto se ilustra bien mediante el siguiente gráfico:

```{r, echo = FALSE, warning = FALSE, message = FALSE}
g2 <- ggplot(db, aes(x = Unidades)) +
      geom_histogram(fill = "#4d85ea") +
      theme_light() +
      ggtitle("Frecuencia del número de vehículos registrados en el RUNT¹ por día",
              subtitle = "¹ Registro Único Nacional de Tránsito") +
      xlab("Número de vehículos registrados por día") +
      ylab("Frecuencia absoluta")
ggplotly(g2)
```

Como se aprecia, lo más frecuente es que en un día se inscriban en el RUNT entre cero y 124 vehpiculos aproximadamente, ya que esto sucedió en 422 de los 2,192 días que abarca el periodo de interés, seguido por entre 746 y 870 vehículos por día, pues en 239 días se registraron un número de vehículos incluido en tal intervalo. De la misma forma, destaca el hecho de que hay pocos días que tengan dos mil o más vehículos registrados por día.

Ahora bien, con el objetivo de entender mejor la dinámica de venta de vehículos, vale la pena observar el comportamiento por mes, año, semana y día de la semana, para lo cual se van a crear tales variables auxiliares con ayuda de $\color{blue}{\textsf{R}}$, lo cual deja la estructura de la base de datos como sigue:


```{r, echo=FALSE}
#Depuraciones Iniciales
db <- db %>% 
  mutate(Fecha = as.Date(Fecha)) %>% 
  mutate(dia = day(Fecha)) %>% 
  mutate(mes = month(Fecha)) %>% 
  mutate(anno = year(Fecha))%>%
  mutate(dia_semana = wday(Fecha)) %>% 
  mutate(semana = week(Fecha))
# db$Fecha<-NULL
```

```{r}
glimpse(db)
```

Y con esto, se va a revisar el comportamiento por mes entre el 2012 y el 2017 (inclusive) del registro de vehículos en el RUNT mediante la siguiente serie de tiempo:

```{r}
dbMesano <- db %>% 
  group_by(anno, mes) %>% 
  summarise(Unidades = sum(Unidades))
```
```{r}
dbMesano <- dbMesano %>%
  mutate("Mes" = paste(mes, anno, sep = "-")) %>% 
  mutate("Mes" = ifelse(nchar(Mes) < 7, paste0("0", Mes), Mes)) %>% 
  mutate("Mes" = as.yearmon(Mes, format = "%m-%Y"))
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
g3 <- ggplot(dbMesano, aes(x = Mes, y = Unidades)) +
      geom_line(color = "#4d85ea") +
      ggtitle("Número de vehículos registrados en el RUNT¹ por mes",
              subtitle = "¹ Registro Único Nacional de Tránsito") +
      xlab("Fecha [mmm - AAAA]") +
      ylab("Vehículos registrados")
      theme_light()
ggplotly(g3)
```
Y como se puede observar, no se puede hablar de que haya una cantidad semejante de vehículos vendidos por mes, ya que en cada año se puede observar que hay una tendencia a la baja al iniciar en el año, pues en cada uno de los meses de enero hay un mínimo de vehículos registrados en el RUNT para sus respectivos años, ocurriendo luego un incremento hacia los meses de marzo, abril y mayo para mantenerse en niveles semejantes hasta que se presenta un máximo en el mes de diciembre, siendo el más destacado el del año 2014, ya que en dicho diciembre se registraron 40,518 vehículos. Así mismo, se evidencia nuevamente una tendencia bajista en el comportamiento global, ya que hay un menor número de registros hacia los años 2018 y 2017 comparado con los demás, siendo 2014 el año con mejores registros, como se verá más adelante. Ahora, se va a analizar el número de vehículos registrados por mes sin importar el año.

```{r}
dbMes <- dbMesano %>% 
  group_by(mes) %>% 
  summarise(Unidades = sum(Unidades))
```

```{r}
meses <- c("Enero","Febrero","Marzo",
            "Abril","Mayo","Junio",
            "Julio","Agosto","Septiembre",
            "Octubre","Noviembre","Diciembre")
dbMes$mesab <- meses[ dbMes$mes ]
dbMes$mes <- NULL
```

```{r}
g4 <- ggplot(dbMes, aes(x = (mesab), y = (Unidades))) +
      geom_bar(stat = "identity", fill = "#4d85ea") +
      theme_light() + 
      ggtitle("Número de vehículos registrados en el RUNT por mes") +
      xlab("Mes") +
      ylab("Vehículos registrados") +
   scale_x_discrete(guide = guide_axis(angle = 30))
g4
```

Y se observa algo que fue confirmado previamente y es que diciembre es el mes con más registros diarios en el RUNT, toda vez que enero es el que menos. Asimismo, se observa que en el resto de meses se estabiliza aproximadamente el registro con al menos de 15,000 registros por mes, siendo febrero y una excepción probablemente por una recuperación luego del mínimo de enero.

# Creación de más variables

Con el fin de generar un modelo de predicción de vehículos registrados en el RUNT durante en el 2018, se van a crear algunas variables adicionales que podrían incidir positivamente en la forma en la que los diferentes modelos a plantear trabajar. Se debe tener en cuenta que lo buenas que resulten dichas variables solo será descubierto una vez se generen los diferentes modelos.

## TRM del día.

Colombia es un país con un débil aparato productivo de vehículos, lo cual se refleja en que en el 2019 se produjeron solo 127,541 vehículos en Colombia (lo cual resulta bajo comparado con los más de 3.9 millones de vehículos fabricados en México) y que contraste con los 223,755 vehículos de uso particular que fueron vendidos en el país durante el mismo año [1]. En ese sentido, es fundamental para abastecer la demanda de vehículos del país buscar en los mercados internacionales tales vehículos, y así, teniendo en cuenta que estas operaciones se tranzan generalmente dólares estadounidenses (USD), se puede considerar el precio de esta divisa en cada día, para lo cual resulta útil consultar el histórico de la tasa representativa del mercado (TRM) calculado por el Banco de la República al final de cada día [2].

```{r}
trm = read_excel("TRM.xlsx")
```

```{r}
# Cambio del tipo de formato de la variable "Fecha" en la base de datos 'TRM'.
trm <- trm %>%
  mutate(Fecha = as.Date(Fecha))
```

```{r}
# Adición de esta variable a la base de datos
db <- merge(x = db, y = trm, by = "Fecha")
```

<!-- ## Precio del barril de petróleo Brent -->

<!-- Colombia es un exportador neto de crudo, cuyo precio por las características del petróleo en el país está determinado por el barril Went, el cual se negocia en los mercados internacionales día y día y que, considerando la pobre capacidad del país para producir derivados como la gasolina, estos productos de valor agregado deben ser importados para poder dar abastecer la demanda nacional. Así, considerando que una de las variables que afecta el precio de la gasolina es el precio del petróleo, se va a considerar la cotización diaria de este *commodity*. -->

## Elementos de la fecha

Para poder identificar patrones estacionarios y otros asociados con el tiempo, se van a crear las siguientes variables:

- *Día.* Identifica el día del mes de cada fecha.
- *Mes.* Identifica el mes del año de cada fecha.
- *Año.* Identifica el año de cada fecha.
- *Día de la semana.* Identifica el día de la semana de cada fecha (ej.: lunes, martes, miércoles, etc.)
- *Semana del año.* Identifica la semana del año asociada a cada fecha, considerando que los primeros siete días del año siempre conformarán la primera semana sin importar el día de la semana asociado a cada uno de estos.

## Días no laborales

La mayoría de puntos del país donde es posible realizar un registro al RUNT solo operan en días laborales, es decir, entre el lunes y el sábado de cada semana, con la excepción de aquellos días que sean festivos, por lo que es importante identificar dichos días para que el modelo pueda incorporarlos y trabajar con ellos.

```{r, include = FALSE}
fest12 <- c("2012-01-01", "2012-01-09", "2012-03-19",
            "2012-04-01", "2012-04-05", "2012-04-06",
	          "2012-04-08", "2012-05-01", "2012-05-21",
            "2012-06-11", "2012-06-18", "2012-07-02",
            "2012-07-20", "2012-08-07", "2012-08-20",
            "2012-10-15", "2012-11-05", "2012-11-12",
            "2012-12-08", "2012-12-25")

fest13 <- c("2013-01-01", "2013-01-07", "2013-03-24",
            "2013-03-25", "2013-03-28", "2013-03-29",
	          "2013-03-31", "2013-05-01", "2013-05-13",
            "2013-06-03", "2013-06-10", "2013-07-01",
            "2013-07-20", "2013-08-07", "2013-08-19",
            "2013-10-14", "2013-11-04", "2013-11-11",
            "2013-12-08", "2013-12-25")
fest14 <- c("2014-01-01", "2014-01-06", "2014-03-24",
             "2014-04-17", "2014-04-18", "2014-05-01",
	           "2014-06-02", "2014-06-23", "2014-06-30",
             "2014-07-20", "2014-08-07", "2014-08-18",
             "2014-10-13", "2014-11-03", "2014-11-17",
             "2014-12-08", "2014-12-25")
fest15 <- c("2015-01-01", "2015-01-12", "2015-03-23",
            "2015-04-02", "2015-04-03", "2015-05-01",
        		"2015-06-08", "2015-06-15", "2015-06-29",
        		"2015-07-20", "2015-08-07", "2015-08-17",
        		"2015-10-12", "2015-11-02", "2015-11-16",
        		"2015-12-08", "2015-12-25", "2015-05-18")
fest16 <- c("2016-01-01", "2016-01-11", "2016-03-21",
            "2016-03-24", "2016-03-25", "2016-05-01",
        		"2016-05-30", "2016-06-06", "2016-07-04",
        		"2016-07-20", "2016-08-07", "2016-08-15",
        		"2016-10-17", "2016-11-07", "2016-11-14",
        		"2016-12-08", "2016-12-25", "2016-05-09")

fest17 <- c("2017-01-01", "2017-01-09", "2017-03-20",
             "2017-04-13", "2017-04-14", "2017-05-01",
		         "2017-05-29", "2017-06-19", "2017-07-03",
        		 "2017-07-20", "2017-08-07", "2017-08-21",
        		 "2017-10-16", "2017-11-06", "2017-11-13",
        		 "2017-12-08", "2017-12-25", "2017-06-26")

fest18 <- c("2018-01-01", "2018-01-08", "2018-03-19",
            "2018-03-19", "2018-03-30", "2018-05-01",
        		"2018-05-14", "2018-06-04", "2018-07-02",
        		"2018-07-20", "2018-08-07", "2018-08-20",
        		"2018-10-15", "2018-11-05", "2018-11-12",
        		"2018-12-08", "2018-12-25", "2018-06-11")
festivos <- c(fest12,fest13,fest14,fest15,fest16,fest17,fest18)
festivos <- as.Date(festivos)
db <- db %>% 
  mutate(Festivo = ifelse((Fecha %in% festivos), 1, 0))
```

```{r}
db <- db %>% 
  mutate(Laboral = ifelse((Festivo == "1" | dia_semana == "1"), 0, 1)) %>% 
  select(-c("Festivo", "Fecha"))
```


```{r}
save(db, file = "RUNT.RData")
```

# Generación de la base de datos de 2018

```{r}
dias18 = seq(as.Date("2018-01-01"), as.Date("2018-12-31"), by="days")
```

```{r}
yr18 = as.data.frame(dias18)
```

```{r}
yr18 = yr18 %>% 
  rename("Fecha" = "dias18")
```


```{r}
yr18 <- yr18 %>% 
  mutate(Fecha = as.Date(Fecha)) %>% 
  mutate(dia = day(Fecha)) %>% 
  mutate(mes = month(Fecha)) %>% 
  mutate(anno = year(Fecha))%>%
  mutate(dia_semana = wday(Fecha)) %>% 
  mutate(semana = week(Fecha))
```

```{r}
yr18 <- yr18 %>% 
  mutate(Festivo = ifelse((Fecha %in% festivos), 1, 0))
```

```{r}
trm18 = read_excel("TRM18.xlsx")
```

```{r}
trm18 = trm18 %>% 
  mutate(Fecha = as.Date(Fecha))
```


```{r}
yr18 <- merge(x = yr18, y = trm18, by = "Fecha")
```


```{r}
yr18 <- yr18 %>% 
  mutate(Laboral = ifelse((Festivo == "1" | dia_semana == "1"), 0, 1)) %>% 
  select(-c("Festivo", "Fecha"))
```

```{r}
save(yr18, file = "yr18.RData")
```

# Referencias

[1] PROCOLOMBIA. "Industria automotriz en Colombia". Procolombia. https://www.colombiatrade.com.co/noticias/industria-automotriz-en-colombia (accedido el 8 de enero de 2022).

[2] Banco de la República de Colombia. "Tasa representativa del mercado (TRM - peso por dólar)". Banco de la República. https://www.banrep.gov.co/es/estadisticas/trm (accedido el 8 de enero de 2022).